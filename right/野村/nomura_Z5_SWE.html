<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>nomura_Z5_SWE</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0; padding: 0;
      background: #f4f4f4;
      -webkit-text-size-adjust: 100%;
    }
    .page-wrapper { padding: 10px 12px 16px 12px; }
    .top-row {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: 10px;
    }
    #plotArea { flex: 1 1 auto; min-width: 0; height: 75vh; }
    #plot { width: 100%; height: 100%; }

    #trialPanel {
      width: 120px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
      justify-content: flex-start;
    }
    .trial-btn {
      width: 100%;
      padding: 8px 6px;
      border-radius: 10px;
      border: 1px solid #1976d2;
      background: #fff;
      color: #1976d2;
      cursor: pointer;
      font-size: 14px;
      touch-action: manipulation;
    }
    .trial-btn.active { background: #1976d2; color: #fff; }

    #bottomPanel {
      margin-top: 10px;
      padding: 10px 12px 12px 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #frameLabel { font-size: 14px; line-height: 1.2; }

    #frameSlider {
      width: 100%;
      height: 44px;
      margin: 0;
      background: transparent;
      touch-action: manipulation;
    }
    #frameSlider::-webkit-slider-runnable-track {
      height: 10px; border-radius: 999px; background: #d0d0d0;
    }
    #frameSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 34px; height: 34px;
      border-radius: 50%;
      background: #1976d2;
      border: 2px solid #fff;
      margin-top: -12px;
    }

    .step-btn {
      height: 44px;
      min-width: 64px;
      font-size: 18px;
      border-radius: 10px;
      border: 1px solid #1976d2;
      background: #fff;
      color: #1976d2;
      touch-action: manipulation;
    }

    @media (max-width: 700px) {
      .top-row { flex-direction: column; }
      #trialPanel {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
      }
      .trial-btn { width: auto; min-width: 80px; }
      #plotArea { height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="top-row">
      <div id="plotArea"><div id="plot"></div></div>
      <div id="trialPanel">
        <div style="font-weight:bold; margin-bottom:4px;">Trial</div>
        <button class="trial-btn" id="trialBtn_1" data-trial="1">1球目</button>
          <button class="trial-btn" id="trialBtn_2" data-trial="2">2球目</button>
          <button class="trial-btn" id="trialBtn_3" data-trial="3">3球目</button>
          <button class="trial-btn" id="trialBtn_4" data-trial="4">4球目</button>
      </div>
    </div>

    <div id="bottomPanel">
      <div id="frameLabel">Frame:</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="prevBtn" class="step-btn">-</button>
        <input type="range" id="frameSlider" min="0" max="0" value="0" step="1">
        <button id="nextBtn" class="step-btn">+</button>
      </div>
    </div>
  </div>

  <script>
    const fig = {"data": [{"line": {"color": "blue", "width": 3}, "mode": "lines", "showlegend": false, "x": [0.3002845, 0.3002845, 0.150155, 2.548099e-05, 0.150155, 0.3002845], "y": [0.150414, -0.150414, -0.150414, -0.0, 0.150414, 0.150414], "z": [-0.4301049, -0.4301049, -0.4301049, -0.4301049, -0.4301049, -0.4301049], "type": "scatter3d"}, {"line": {"color": "blue", "width": 3}, "mode": "lines", "showlegend": false, "x": [0.3002845, 0.3002845, 0.150155, 2.548099e-05, 0.150155, 0.3002845], "y": [0.150414, -0.150414, -0.150414, -0.0, 0.150414, 0.150414], "z": [0.2297358, 0.2297358, 0.2297358, 0.2297358, 0.2297358, 0.2297358], "type": "scatter3d"}, {"line": {"color": "blue", "width": 2.5}, "mode": "lines", "opacity": 0.3, "showlegend": false, "x": [0.3002845, 0.3002845], "y": [0.150414, 0.150414], "z": [-0.4301049, 0.2297358], "type": "scatter3d"}, {"line": {"color": "blue", "width": 2.5}, "mode": "lines", "opacity": 0.3, "showlegend": false, "x": [0.3002845, 0.3002845], "y": [-0.150414, -0.150414], "z": [-0.4301049, 0.2297358], "type": "scatter3d"}, {"line": {"color": "blue", "width": 2.5}, "mode": "lines", "opacity": 0.3, "showlegend": false, "x": [0.150155, 0.150155], "y": [-0.150414, -0.150414], "z": [-0.4301049, 0.2297358], "type": "scatter3d"}, {"line": {"color": "blue", "width": 2.5}, "mode": "lines", "opacity": 0.3, "showlegend": false, "x": [2.548099e-05, 2.548099e-05], "y": [-0.0, -0.0], "z": [-0.4301049, 0.2297358], "type": "scatter3d"}, {"line": {"color": "blue", "width": 2.5}, "mode": "lines", "opacity": 0.3, "showlegend": false, "x": [0.150155, 0.150155], "y": [0.150414, 0.150414], "z": [-0.4301049, 0.2297358], "type": "scatter3d"}, {"marker": {"color": "white", "line": {"color": "blue", "width": 1}, "size": 5}, "mode": "markers+text", "showlegend": false, "text": ["Z1", "Z2", "Z3", "Z4", "Z5", "Z6", "Z7", "Z8", "Z9"], "textposition": "top center", "x": [0.3002845, 0.3002845, 0.3002845, 0.3002845, 0.3002845, 0.3002845, 0.3002845, 0.3002845, 0.3002845], "y": [0.100276, -0.0, -0.100276, 0.100276, -0.0, -0.100276, 0.100276, -0.0, -0.100276], "z": [0.1197624, 0.1197624, 0.1197624, -0.1001846, -0.1001846, -0.1001846, -0.3201314, -0.3201314, -0.3201314], "type": "scatter3d"}, {"line": {"color": "black", "width": 4}, "mode": "lines", "showlegend": false, "x": [0.266990840435028, 0.311688482761383], "y": [-0.0419593974947929, 0.55917763710022], "z": [-0.352251589298248, 0.173710480332375], "type": "scatter3d"}, {"marker": {"color": "white", "line": {"color": "red", "width": 3}, "size": 10, "symbol": "circle"}, "mode": "markers", "showlegend": false, "x": [0.311688482761383], "y": [0.55917763710022], "z": [0.173710480332375], "type": "scatter3d"}, {"marker": {"color": "orange", "size": 7}, "mode": "markers", "showlegend": false, "x": [0.2725780469817159], "y": [0.03318274872005199], "z": [-0.286506315816183], "type": "scatter3d"}, {"marker": {"color": "blue", "size": 7, "symbol": "x"}, "mode": "markers", "showlegend": false, "x": [0.154346406459808], "y": [-0.0], "z": [-0.100184559822083], "type": "scatter3d"}, {"line": {"color": "purple", "dash": "dash", "width": 3}, "mode": "lines", "showlegend": false, "x": [0.2725780469817159, 0.154346406459808], "y": [0.03318274872005199, -0.0], "z": [-0.286506315816183, -0.100184559822083], "type": "scatter3d"}], "layout": {"template": {"data": {"histogram2dcontour": [{"type": "histogram2dcontour", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "choropleth": [{"type": "choropleth", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "histogram2d": [{"type": "histogram2d", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "heatmap": [{"type": "heatmap", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "heatmapgl": [{"type": "heatmapgl", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "contourcarpet": [{"type": "contourcarpet", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "contour": [{"type": "contour", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "surface": [{"type": "surface", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "mesh3d": [{"type": "mesh3d", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "scatter": [{"fillpattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}, "type": "scatter"}], "parcoords": [{"type": "parcoords", "line": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterpolargl": [{"type": "scatterpolargl", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "bar": [{"error_x": {"color": "#2a3f5f"}, "error_y": {"color": "#2a3f5f"}, "marker": {"line": {"color": "#E5ECF6", "width": 0.5}, "pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "bar"}], "scattergeo": [{"type": "scattergeo", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterpolar": [{"type": "scatterpolar", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "histogram": [{"marker": {"pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "histogram"}], "scattergl": [{"type": "scattergl", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatter3d": [{"type": "scatter3d", "line": {"colorbar": {"outlinewidth": 0, "ticks": ""}}, "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scattermapbox": [{"type": "scattermapbox", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterternary": [{"type": "scatterternary", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scattercarpet": [{"type": "scattercarpet", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "carpet": [{"aaxis": {"endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f"}, "baxis": {"endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f"}, "type": "carpet"}], "table": [{"cells": {"fill": {"color": "#EBF0F8"}, "line": {"color": "white"}}, "header": {"fill": {"color": "#C8D4E3"}, "line": {"color": "white"}}, "type": "table"}], "barpolar": [{"marker": {"line": {"color": "#E5ECF6", "width": 0.5}, "pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "barpolar"}], "pie": [{"automargin": true, "type": "pie"}]}, "layout": {"autotypenumbers": "strict", "colorway": ["#636efa", "#EF553B", "#00cc96", "#ab63fa", "#FFA15A", "#19d3f3", "#FF6692", "#B6E880", "#FF97FF", "#FECB52"], "font": {"color": "#2a3f5f"}, "hovermode": "closest", "hoverlabel": {"align": "left"}, "paper_bgcolor": "white", "plot_bgcolor": "#E5ECF6", "polar": {"bgcolor": "#E5ECF6", "angularaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "radialaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}}, "ternary": {"bgcolor": "#E5ECF6", "aaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "baxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "caxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}}, "coloraxis": {"colorbar": {"outlinewidth": 0, "ticks": ""}}, "colorscale": {"sequential": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "sequentialminus": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "diverging": [[0, "#8e0152"], [0.1, "#c51b7d"], [0.2, "#de77ae"], [0.3, "#f1b6da"], [0.4, "#fde0ef"], [0.5, "#f7f7f7"], [0.6, "#e6f5d0"], [0.7, "#b8e186"], [0.8, "#7fbc41"], [0.9, "#4d9221"], [1, "#276419"]]}, "xaxis": {"gridcolor": "white", "linecolor": "white", "ticks": "", "title": {"standoff": 15}, "zerolinecolor": "white", "automargin": true, "zerolinewidth": 2}, "yaxis": {"gridcolor": "white", "linecolor": "white", "ticks": "", "title": {"standoff": 15}, "zerolinecolor": "white", "automargin": true, "zerolinewidth": 2}, "scene": {"xaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}, "yaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}, "zaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}}, "shapedefaults": {"line": {"color": "#2a3f5f"}}, "annotationdefaults": {"arrowcolor": "#2a3f5f", "arrowhead": 0, "arrowwidth": 1}, "geo": {"bgcolor": "white", "landcolor": "#E5ECF6", "subunitcolor": "white", "showland": true, "showlakes": true, "lakecolor": "white"}, "title": {"x": 0.05}, "mapbox": {"style": "light"}}}, "scene": {"camera": {"eye": {"x": 1.6, "y": 1.6, "z": 1.0}, "center": {"x": 0, "y": 0, "z": 0}, "up": {"x": 0, "y": 0, "z": 1}}, "xaxis": {"title": {"text": "\u6a2a Z [m]"}}, "yaxis": {"title": {"text": "\u5965\u884c X [m]"}}, "zaxis": {"title": {"text": "\u7e26 Y [m]"}}, "aspectmode": "data"}, "margin": {"l": 0, "r": 0, "t": 60, "b": 120}, "title": {"text": "Z5 (Z5)  |  offset=10 cm from TOP"}, "showlegend": false, "uirevision": "KEEP_CAMERA_FOREVER"}};
    const trialInfo = {"1": [{"index": -4, "is_min": false, "A": [-0.944331765174866, 0.240362778306007, 0.0894858166575432], "B": [-0.167410135269165, 0.0782458633184433, -0.0110670505091548], "S": [-0.8472165608475782, 0.22009816380964176, 0.07691670818546506], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -3, "is_min": false, "A": [-0.707556486129761, -0.0124994432553649, -0.0975990891456604], "B": [0.0651789009571075, 0.163434982299805, 0.0116124581545591], "S": [-0.6109645674690151, 0.009492358863229718, -0.08394764640093835], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -2, "is_min": false, "A": [-0.42046320438385, -0.126810491085052, -0.236626446247101], "B": [0.204095989465714, 0.277739256620407, 0.0570838078856468], "S": [-0.34239332945027023, -0.0762417883603207, -0.19991267590690068], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -1, "is_min": false, "A": [-0.109635323286057, -0.147572055459023, -0.348345160484314], "B": [0.2981036901474, 0.379794538021088, 0.0939597189426422], "S": [-0.05866795589883829, -0.08165124329216518, -0.29305706063562936], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 0, "is_min": false, "A": [-0.109635323286057, -0.147572055459023, -0.348345160484314], "B": [0.2981036901474, 0.379794538021088, 0.0939597189426422], "S": [-0.05866795589883829, -0.08165124329216518, -0.29305706063562936], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 1, "is_min": true, "A": [0.266990840435028, -0.0419593974947929, -0.352251589298248], "B": [0.311688482761383, 0.55917763710022, 0.173710480332375], "S": [0.2725780469817159, 0.03318274872005199, -0.286506315816183], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 2, "is_min": false, "A": [0.578465342521667, 0.148772150278091, -0.305452942848206], "B": [0.302045345306396, 0.678447484970093, 0.226558893918991], "S": [0.5439128582429643, 0.21498153765649053, -0.23895149284035255], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 3, "is_min": false, "A": [0.787128329277039, 0.46752655506134, -0.228505730628967], "B": [0.247187227010727, 0.784855604171753, 0.269255667924881], "S": [0.7196357193985723, 0.5071926698001848, -0.1662855815346592], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 4, "is_min": false, "A": [0.70838463306427, 0.860357403755188, -0.157925963401794], "B": [0.0322461985051632, 0.823730707168579, 0.268096566200256], "S": [0.6238673217003532, 0.855779066300284, -0.10467314276322351], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 5, "is_min": false, "A": [0.540124773979187, 1.1587975025177, 0.00182500761002302], "B": [-0.116732493042946, 0.742304027080536, 0.189099460840225], "S": [0.4580176159320418, 1.1067358182976916, 0.025234314169535865], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 6, "is_min": false, "A": [0.414380341768265, 1.2504369020462, 0.0352024249732494], "B": [-0.137601837515831, 0.678460717201233, 0.125528201460838], "S": [0.34538256009561463, 1.1789398693429458, 0.04649314854984444], "P": [0.154346406459808, -0.0, -0.100184559822083]}], "2": [{"index": -3, "is_min": false, "A": [-0.826794803142548, 0.101637281477451, 0.0112395938485861], "B": [-0.0343591421842575, 0.20960046350956, 0.0309752505272627], "S": [-0.727740331715298, 0.11513268111262395, 0.01370655127729637], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -2, "is_min": false, "A": [-0.626158773899078, -0.0342189110815525, -0.138533681631088], "B": [0.0947067588567734, 0.263328611850739, 0.0398436188697815], "S": [-0.536050589770376, 0.002974526203377098, -0.11623652091587736], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -1, "is_min": false, "A": [-0.369335651397705, -0.109448492527008, -0.284480720758438], "B": [0.209891557693481, 0.327199935913086, 0.0529126897454262], "S": [-0.29693226854667687, -0.05486745275635924, -0.24230655509647978], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 0, "is_min": false, "A": [-0.369335651397705, -0.109448492527008, -0.284480720758438], "B": [0.209891557693481, 0.327199935913086, 0.0529126897454262], "S": [-0.29693226854667687, -0.05486745275635924, -0.24230655509647978], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 1, "is_min": false, "A": [-0.128073021769524, -0.150797560811043, -0.415704995393753], "B": [0.307790368795395, 0.341497868299484, 0.0400016717612743], "S": [-0.07359010864319768, -0.08926064425112498, -0.35874167318053524], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 2, "is_min": true, "A": [0.394284665584564, 0.108243867754936, -0.323497474193573], "B": [0.27207088470459, 0.70731246471405, 0.192429423332214], "S": [0.3790079424457315, 0.1831274449670769, -0.25900660977036344], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 3, "is_min": false, "A": [0.669735252857208, 0.358657121658325, -0.251181393861771], "B": [0.23712320625782, 0.825198769569397, 0.23377799987793], "S": [0.6156587430473047, 0.41697483194472923, -0.19056146517713418], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 4, "is_min": false, "A": [0.7982457280159, 0.727504193782806, -0.181568026542664], "B": [0.158629670739174, 0.920100152492523, 0.258657097816467], "S": [0.7182937248635629, 0.7515786874148891, -0.1265398887558237], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 5, "is_min": false, "A": [0.642802953720093, 1.07336163520813, -0.130067020654678], "B": [-0.058048602193594, 0.909404993057251, 0.219111114740372], "S": [0.5551965129384134, 1.052867055806607, -0.08641975557746231], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 6, "is_min": false, "A": [0.476010084152222, 1.33051705360413, -0.0564414449036121], "B": [-0.140720382332802, 0.876792430877686, 0.175458133220673], "S": [0.39891877077605076, 1.273801472036637, -0.027453995733358914], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 7, "is_min": false, "A": [0.250870615243912, 1.37797331809998, -0.147631898522377], "B": [-0.177256837487221, 0.730883359909058, 0.0472563840448856], "S": [0.19735468250090749, 1.2970870715855183, -0.12327086267724241], "P": [0.154346406459808, -0.0, -0.100184559822083]}], "3": [{"index": -6, "is_min": false, "A": [-0.881502032279968, 0.451314449310303, 0.182017356157303], "B": [-0.135627508163452, 0.179745748639107, 0.0824085846543312], "S": [-0.7882677365974005, 0.41736836894712154, 0.16956626236792102], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -5, "is_min": false, "A": [-0.793219566345215, 0.261272132396698, 0.0731180235743523], "B": [0.00509173050522804, 0.220521092414856, 0.105341963469982], "S": [-0.6934306508274566, 0.2561782522248248, 0.07714601619900976], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -4, "is_min": false, "A": [-0.648048400878906, 0.10442641377449, -0.0498023629188538], "B": [0.117709502577782, 0.261593729257584, 0.120236441493034], "S": [-0.5523286574704817, 0.12407232933386306, -0.02854751115133071], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -3, "is_min": false, "A": [-0.405584782361984, -0.0398022085428238, -0.126663848757744], "B": [0.209781363606453, 0.37892872095108, 0.166574388742447], "S": [-0.32866399902329463, 0.012539167913820967, -0.09000906187818067], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -2, "is_min": false, "A": [-0.134465366601944, -0.0960200279951096, -0.246594980359077], "B": [0.307565271854401, 0.418618947267532, 0.177380904555321], "S": [-0.07921153296090855, -0.031690151623512186, -0.19359799106738448], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -1, "is_min": true, "A": [0.169629842042923, -0.0862997174263, -0.347816348075867], "B": [0.405596882104874, 0.458725214004517, 0.18815690279007], "S": [0.1991257233060723, -0.01817159809777484, -0.2808196888661091], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 0, "is_min": false, "A": [0.169629842042923, -0.0862997174263, -0.347816348075867], "B": [0.405596882104874, 0.458725214004517, 0.18815690279007], "S": [0.1991257233060723, -0.01817159809777484, -0.2808196888661091], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 1, "is_min": false, "A": [0.491190165281296, 0.0558274574577808, -0.128050461411476], "B": [0.186224743723869, 0.685339212417603, 0.260165423154831], "S": [0.4530695034009678, 0.13451639418366643, -0.07952349597209106], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 2, "is_min": false, "A": [0.703611016273499, 0.303530156612396, -0.0892124697566032], "B": [0.126962780952454, 0.73667699098587, 0.256996512413025], "S": [0.6315299883654005, 0.3576735097770795, -0.04593634789019406], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 3, "is_min": false, "A": [0.812115967273712, 0.515525281429291, 0.0550573691725731], "B": [0.045969657599926, 0.69568532705307, 0.198452308773994], "S": [0.7163476724719205, 0.5380452885649367, 0.0729817377630596], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 4, "is_min": false, "A": [0.816217958927155, 0.801254630088806, 0.103256203234196], "B": [0.0277992151677608, 0.673009634017944, 0.147406950592995], "S": [0.7176656300487265, 0.7852240078720854, 0.10877504586493467], "P": [0.154346406459808, -0.0, -0.100184559822083]}], "4": [{"index": -6, "is_min": false, "A": [-0.856639087200165, 0.371515512466431, 0.0447862185537815], "B": [-0.0965555161237717, 0.122596070170403, 0.0271154455840588], "S": [-0.761628654175756, 0.34040058655473404, 0.042577372243168855], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -5, "is_min": false, "A": [-0.575582563877106, 0.0615688003599644, -0.119919635355473], "B": [0.170823305845261, 0.226398065686226, 0.116108991205692], "S": [-0.4822818244486229, 0.08217245978739374, -0.09041605522870205], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -4, "is_min": false, "A": [-0.63151627779007, 0.133532479405403, -0.052468828856945], "B": [0.132304310798645, 0.271074265241623, 0.141594380140305], "S": [-0.5360387164114512, 0.15072520043897236, -0.028210930830653937], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -3, "is_min": false, "A": [-0.402536302804947, -0.0149830859154463, -0.13398689031601], "B": [0.211349472403526, 0.385068327188492, 0.187110066413879], "S": [-0.32580058892222774, 0.03502333549722832, -0.0938497749188188], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -2, "is_min": false, "A": [-0.121036730706692, -0.0887146592140198, -0.195406138896942], "B": [0.261181801557541, 0.477346211671829, 0.221107929944992], "S": [-0.07325940989973996, -0.017957044023662258, -0.14334187563428866], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": -1, "is_min": true, "A": [0.191656142473221, -0.104091048240662, -0.141463190317154], "B": [0.205858379602432, 0.592659890651703, 0.251394242048264], "S": [0.19343142137020944, -0.016997217387183433, -0.09235603185625774], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 0, "is_min": false, "A": [0.191656142473221, -0.104091048240662, -0.141463190317154], "B": [0.205858379602432, 0.592659890651703, 0.251394242048264], "S": [0.19343142137020944, -0.016997217387183433, -0.09235603185625774], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 1, "is_min": false, "A": [0.483579397201538, 0.0240035876631737, -0.1115503013134], "B": [0.168594673275948, 0.658784210681915, 0.259715467691422], "S": [0.4442063093839421, 0.10335116015348071, -0.06514208333852659], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 2, "is_min": false, "A": [0.703065514564514, 0.240954250097275, -0.0523417219519615], "B": [0.115798115730286, 0.694196820259094, 0.247138798236847], "S": [0.6296571130582884, 0.29760955334788897, -0.014906668834839563], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 3, "is_min": false, "A": [0.8277228474617, 0.436142206192017, 0.0559565424919128], "B": [0.0655204877257347, 0.648505330085754, 0.174065589904785], "S": [0.7324475733851276, 0.4626875908582909, 0.07072017018139201], "P": [0.154346406459808, -0.0, -0.100184559822083]}, {"index": 4, "is_min": false, "A": [0.852009773254395, 0.72333300113678, 0.0519655682146549], "B": [0.0607382878661156, 0.625685334205627, 0.117953322827816], "S": [0.7531008386784832, 0.7111270429058392, 0.06021403744976421], "P": [0.154346406459808, -0.0, -0.100184559822083]}]};

    const STATIC_COUNT  = 8;
    const DYNAMIC_COUNT = 5;

    let currentTrial = "1";
    let currentCamera = null;

    // restyle対象トレース（動的5本）
    function dynamicTraceIndices() {
      const arr = [];
      for (let i = 0; i < DYNAMIC_COUNT; i++) arr.push(STATIC_COUNT + i);
      return arr;
    }
    const DYN_IDX = dynamicTraceIndices();

    document.addEventListener("DOMContentLoaded", function() {
      const plotDiv = document.getElementById("plot");
      const slider = document.getElementById("frameSlider");
      const frameLabel = document.getElementById("frameLabel");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      Plotly.newPlot(
        plotDiv,
        fig.data,
        fig.layout,
        {
          responsive: true,
          displayModeBar: true,
          scrollZoom: false
        }
      ).then(function(gd) {
        // 初期 camera 保存
        if (gd.layout && gd.layout.scene && gd.layout.scene.camera) {
          currentCamera = gd.layout.scene.camera;
        }

        // ユーザー操作で camera 変化を保存
        gd.on('plotly_relayout', function(ev) {
          if (ev['scene.camera']) {
            currentCamera = ev['scene.camera'];
            return;
          }
          const hasCamKey = Object.keys(ev).some(k => k.startsWith('scene.camera'));
          if (hasCamKey && gd.layout && gd.layout.scene && gd.layout.scene.camera) {
            currentCamera = gd.layout.scene.camera;
          }
        });

        // 端末回転/リサイズ：Plotlyが勝手に変えることがあるので再適用
        let resizeTimer = null;
        function handleResize() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(function() {
            Plotly.Plots.resize(gd).then(function() {
              if (currentCamera) Plotly.relayout(gd, {'scene.camera': currentCamera});
            });
          }, 150);
        }
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);

        // Trial buttons
        Object.keys(trialInfo).forEach(function(trialKey) {
          const btn = document.getElementById("trialBtn_" + trialKey);
          if (!btn) return;

          btn.addEventListener("click", function() {
            document.querySelectorAll(".trial-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            currentTrial = trialKey;
            updateSliderForTrial(gd, currentTrial);
          });
        });

        // Slider
        slider.addEventListener("input", function() {
          updateFrame(gd, currentTrial, Number(slider.value));
        });
        slider.addEventListener("change", function() {
          updateFrame(gd, currentTrial, Number(slider.value));
        });

        // ±
        prevBtn.addEventListener("click", function() {
          const v = Math.max(Number(slider.min), Number(slider.value) - 1);
          slider.value = v;
          updateFrame(gd, currentTrial, v);
        });
        nextBtn.addEventListener("click", function() {
          const v = Math.min(Number(slider.max), Number(slider.value) + 1);
          slider.value = v;
          updateFrame(gd, currentTrial, v);
        });

        // init active
        const initBtn = document.getElementById("trialBtn_1");
        if (initBtn) initBtn.classList.add("active");

        // init
        updateSliderForTrial(gd, currentTrial);

        function updateSliderForTrial(gd, trialKey) {
          const frames = trialInfo[trialKey];
          if (!frames || frames.length === 0) return;

          slider.min = 0;
          slider.max = frames.length - 1;

          // 初期は MIN 位置
          let initPos = 0;
          for (let i = 0; i < frames.length; i++) {
            if (frames[i].is_min) { initPos = i; break; }
          }
          slider.value = initPos;

          updateFrame(gd, trialKey, initPos);
        }

        // ★ここが本丸：restyle で x/y/z だけ更新（レイアウト触らない→カメラ戻らない）
        function updateFrame(gd, trialKey, idxInTrial) {
          const frames = trialInfo[trialKey];
          if (!frames || frames.length === 0) return;

          const clamped = Math.max(0, Math.min(idxInTrial, frames.length - 1));
          const f = frames[clamped];

          // Bat line (trace 0)
          const x0 = [f.A[0], f.B[0]];
          const y0 = [f.A[1], f.B[1]];
          const z0 = [f.A[2], f.B[2]];

          // Bottom marker (trace 1)
          const x1 = [f.B[0]];
          const y1 = [f.B[1]];
          const z1 = [f.B[2]];

          // Sweet (trace 2)
          const x2 = [f.S[0]];
          const y2 = [f.S[1]];
          const z2 = [f.S[2]];

          // Ball (trace 3)
          const x3 = [f.P[0]];
          const y3 = [f.P[1]];
          const z3 = [f.P[2]];

          // S->P (trace 4)
          const x4 = [f.S[0], f.P[0]];
          const y4 = [f.S[1], f.P[1]];
          const z4 = [f.S[2], f.P[2]];

          // restyle は「配列の配列」にするのがコツ
          Plotly.restyle(gd, {
            x: [x0, x1, x2, x3, x4],
            y: [y0, y1, y2, y3, y4],
            z: [z0, z1, z2, z3, z4],
          }, DYN_IDX).then(function() {
            // 念押し：カメラ保持（restyleだけなら基本不要だが、iOS保険）
            if (currentCamera) Plotly.relayout(gd, {'scene.camera': currentCamera});
          });

          frameLabel.textContent =
            "Trial " + trialKey +
            " / frame index = " + f.index +
            " (step " + clamped + ")" +
            (f.is_min ? "  ★MIN" : "");
        }
      });
    });
  </script>
</body>
</html>
